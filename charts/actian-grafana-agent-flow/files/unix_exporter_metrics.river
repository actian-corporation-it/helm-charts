// Prometheus Unix Exporter discovery input
argument "targets" {
	optional = false
}
// forward_metrics_to must be a list(MetricsReceiver) where collected metrics
// should be forwarded.
argument "forward_metrics_to" {
	optional = false
}

// scrape_interval is a duration which specifies how frequently to collect
// metrics.
argument "scrape_interval" {
	optional = true
	default  = "30s"
}

// scrape_timeout is a duration which specifies how long to wait for a single
// metrics collection to complete.
argument "scrape_timeout" {
	optional = true
	default  = "10s"
}

discovery.relabel "unix_exporter" {
	targets = argument.targets.value

	rule {
		action       = "replace"
		target_label = "job"
		replacement  = "integrations/node_exporter"
	}

	rule {
		action        = "replace"
		source_labels = ["__address__"]
		target_label  = "__port__"
		regex         = ".*:(.*)"
		replacement   = "$1"
	}

	rule {
		action        = "replace"
		source_labels = ["__meta_agent_hostname", "__port__"]
		separator     = ":"
		target_label  = "instance"
	}
}

prometheus.scrape "unix_exporter_metrics" {
	targets = discovery.relabel.unix_exporter.output
	// targets = argument.unix_exporter_targets.value

	forward_to = [prometheus.relabel.unix_exporter_metrics.receiver]
	// forward_to = argument.forward_metrics_to.value

	bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"

	scrape_interval = argument.scrape_interval.value
	scrape_timeout  = argument.scrape_timeout.value

	tls_config {
		ca_file              = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
		insecure_skip_verify = false
		server_name          = "kubernetes"
	}
}

prometheus.relabel "unix_exporter_metrics" {
	rule {
		source_labels = ["__name__"]
		action        = "drop"
		regex         = "go_.*"
	}

	rule {
		source_labels = ["__name__"]
		action        = "keep"
		regex         = "node_cpu_seconds_total|node_filesystem.*|node_load.*|node_memory_MemTotal_bytes|node_memory_MemAvailable_bytes|node_memory_Buffers_bytes|node_memory_Cached_bytes|node_memory_MemFree_bytes|node_memory_Slab_bytes|node_netstat_Tcp_RetransSegs|node_netstat_Tcp_OutSegs|node_netstat_TcpExt_TCPSynRetrans|node_network_receive_bytes_total|node_network_transmit_bytes_total|node_time_seconds|node_boot_time_seconds"
	}

	forward_to = argument.forward_metrics_to.value
}
